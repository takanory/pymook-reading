================================================
 第5回 環境構築の自動化、活躍の場が広がるPython
================================================

.. contents:: 目次
   :local:

はじめに
========
鈴木たかのりです。

`前回 <http://gihyo.jp/news/report/01/python-training-book-reading-club/0004>`_
に引き続き
`Pythonエンジニア養成読本 <http://gihyo.jp/book/2015/978-4-7741-7320-7>`_
という書籍の `読書会イベント <http://pymook.connpass.com/>`_ についてレポートします。

今回が最終回となる `第5回の読書会 <http://pymook.connpass.com/event/19107/>`_ は9月17日(木)に `アライドアーキテクツ株式会社 <http://www.aainc.co.jp/>`_ の会議室で開催されました。

当日はだいたい以下のタイムテーブルで進めました。

- 19:00-19:15 参加者の自己紹介
- 19:15-20:50 「第6章 環境構築の自動化」
- 20:50-21:00 「Appendix 2 活躍の場が広がるPython」
- 21:00-22:00 ビアバッシュ(ビールとピザでの参加者懇親会)

今回も今までと同様に書籍の読みあわせはせず、補足情報や質疑応答を中心に解説を行いました。

自己紹介
========
最初に参加者の自己紹介です。
この読書会の3日前に開催された `Ansible Meetup in Tokyo 2015.09 <http://ansible-users.connpass.com/event/18015/>`_ に参加して、今日は違う話が聞けるかなと思って参加した方や、会社ではChefを使っているがAnsibleに切り替えたいと思っている方、業務などで普段Ansibleを使用している方などさまざまな人がいました。

第6章 環境構築の自動化
======================
一通り自己紹介を終えると、6章の著者の若山 史郎(`@r_rudi <https://twitter.com/r_rudi>`)から自己紹介がありました。

.. figure:: /_static/event5/P9171508.JPG
   :width: 400px
   :alt: 若山 史郎氏

   若山 史郎氏

6章のAnsibleでの環境構築の章の執筆担当で、普段は業務ではGoでプログラミングをしていてPythonは書いていないそうです。以前は仕事でもPython書いていたとのこと。
会社ではWebアプリの開発から運用までをカバーしているため、Ansibleも義有無で使用しているとのこと。

この書籍の執筆では、入門Ansibleという書籍を出しており、それで声がかかったそうです(まぁ、私が声をかけたようなものですが)。

- `入門Ansible <http://www.amazon.co.jp/dp/B00MALTGDY/>`_

.. figure:: /_static/event5/P9171352.JPG
   :width: 400px
   :alt: 自己紹介の様子

   自己紹介の様子

この章で使用する `Ansible <http://www.ansible.com/>`_ はPythonで書かれていますが、普通に使用する分にはPythonでのプログラミングは行いません。
とはいえ、拡張を作成するときにはPythonが必要となります。

と、ここで読書会の本題に入ろうとしたのですが、若山さんは書籍のPDFを用意しておらず、本を読みながら進めようと思っていたとのこと。
それだとみんなでどこの話ししているかわかりにくいので、急遽書籍のPDFを受け渡したりするというグダグダな感じでスタートしました。

6-1 環境構築をなぜ自動化すべきか
--------------------------------
この節ではAnsibleの前に、なぜ環境構築を自動化するのか、そのメリットについて解説しています。

環境構築の対象となるサーバー台数が1台、2台と少なければ手作業でも問題ありませんが、台数が増えていくと手作業ではミスが発生する可能性が高いため自動は必須です。
自動化を行うのであれば、それは Ansible ではなく
`Chef <https://www.chef.io/chef/>`_ や
`Puppet <https://puppetlabs.com/>`_ でも問題ありません。

次の書籍にも載っている図はAnsibleを想定しています。Ansibelは対象サーバー(環境を構築する対象となるサーバー)にsshで接続して環境構築を行います。これは、対象サーバーにエージェントと呼ばれるプログラムをインストールする必要があるChefとは異なります。

.. figure:: /_static/event5/automation.png
   :width: 400
   :alt: 環境構築の自動化

   環境構築の自動化

また、環境構築の手順を Git などのリポジトリでバージョン管理することにより、うまく動作しない場合に元に戻したり、差分などの確認が行えるのが便利とのことです。

最近、SIerなどからも「Ansible使いたい」という話がよく聞かれるそうです。理由としてはChefなどはエージェントをインストールする必要があるため、そこがお客さんにいやがられるそうです。そのため、エージェントが不要なAnsibleが向いているとのことです。

ここでは以下の様な質疑応答がありました。

- Q: Ansible以外にもエージェントが不要sshだけで動作する環境構築ツールはあるか?
- A: 最近はChefや `SaltStack <http://saltstack.com/>`_ もエージェント不要で動作するようになってきている。これらは途中から思想を変えてきたが、最初から設計がssh前提のAnsibleの方が筋がいいとのことです。
- Q: Windowsの環境構築で使用可能か?
- A: WindowsとはWinRM(Windows Remote Management)経由で接続しPowerShellでの環境構築が可能。しかし、まだ洗練はされていない。
- Q: Chefのようにエージェントをインストールする利点はなにか?
- A: sshが通らない環境ではエージェントが必要となる場合がある。Ansibleにも **ansible-pull** というコマンドが付属しており、cronで最新の手順を取得して自分自身の環境に適用するといった使い方ができる。この使い方はエージェントっぽくもある。

6-2 Ansibleの導入
-----------------
Ansibleのインストールはpipでインストールしようって書いているが、Linuxだとパッケージ管理でインストールできる。
pipでインストールすると依存ライブラリが入らないため、パッケージ管理で入れたほうがいいかも。

ColumnでPython3系への対応と書いているが、もうすぐAnsible 2がリリースされるがPython 3対応はしていない。
準備は進めており、python 3 対応のPRを受け入れている状況。

- tasksの中にタスクを入れる
- YAMLの中にjinja2のテンプレートで変数が入れられる。
- playbookはtaskを積み重ねて構築する
- taskには名前を日本語で書けるので、日本語で書くのオススメ

本だと白黒なんだけど実際はCHANGESは黄色でOKは緑になる

何回実行しても同じ状態になることを「冪等性」という。これが環境構築だと大事。

AnsibleだとちょっとずつPlaybookを継ぎ足しながら環境を構築していくので便利。冪等性があるので、同じことを繰り返しても大丈夫。

- Q: Ansible Playbookでハイフンが入っていたり、入ってないのとかがあるが、これはなに?
- A: これはYAMLのフォーマットのため。ハイフンがリスト、:で区切っているのがdict
- Q: nameに日本語を書いているが文字コードは?
- A: utf-8しか使えない。以前は日本語使えなかったが Pull Request を送ってutf-8を通るようにしてもらった。ほとんどの個所では日本語は使えるはず。
- A: 一箇所だけ、debug printの最中に日本語を入れようとすると、変数を展開するときに日本語が通じないところがある。もしかしたら Ansible 2.0 で解消しているかもしれない

sudo はいまは become って名前に統一された

- Q: 運用をしている人はどれくらいいます?
- A: 2人くらい。構築までで運用はしない人もいる。構築は手作業でやっている。台数は一桁。

こうちく1回だけで一桁なのであれば、手でやってもよいと思うが、長く運用する場合はAnsibleなどのツールがほしくなる。

昔はCluster SSHで複数のホストに同じコマンドを送ったりしていた。
  
6-3 少し高度な使い方
--------------------
- with_items
- with_itemsのループだとシンプルなループ処理しかできない
- 複雑なループを書きたい場合はPythonで書く必要がある。Pluginを書いて組み込む
- fileモジュールを拡張することとかもできる

Pluginの書き方は「入門Ansible」に書いてある!!

- when
  
Ansibleを実行すると、対象のサーバーに入って情報を収集する。ディストリビューションとバージョン、カーネルのバージョン、IPアドレス等々。その情報を利用して条件分岐ができる。「CentOS 6ならこれを実行する」みたいなこともできる。

- roles

rolesは大事な機能で、これを使いこなせるとAnsibleが上手に使える。しかし紙面ではあんまり触れていない。

組み合わせでroleをうまく使おう。

書籍では ansible-galaxy から role を取得して使っている。

実際に運用でもansible-galaxyで探して使っている。対応しているplatformとかで絞られるので、だいたい決まってくる。Linuxのdistributionが違う場合は、githubでforkして自分で修正したりとかもできる。

- register

  モジュールが実行した結果を変数に保存する。

- local_action

  Ansibleを実行している管理サーバー側で実行するもの。
  EC2のインスタンスを立ち上げたりするとかは、Ansibleの管理サーバー側で行うと思うので、そういうときに使う。

Ansibleでクラウド操作ができる。

ec2とかtagつける、snapshotとる、route53にゾーンつける、Azure, Digital Oceanとかも使える。などなど、クラウドサービス対応が沢山ある。
これらのコマンドは管理サーバー側でやるのが普通かな。

AWSをシェフで構築するツールCloudFormation+OpsWorksを使うっていうのがAWS側が提供している考え方。
それと同じことはAnsibleだけでできる。

- Q: AWS使う時の管理サーバーはローカルでやるのか、AWS上でやるのか?
- A: どっちもあり。みんなが入って使えるAnsible実行ホストを用意するという手もある

- Q: rolesの切り方とか変数の置き方に悩まないか
- A: あまりない。rolesの切り方をミスるとそういうことがおきる。ロールはアプリとかミドルウェアごとに作る。ロールの中だけで完結するようにする。role dependency は使っていない、使わない方がいい。AロールはBロールに依存しているという風に書ける、そのように書くと勝手に実行されて便利だが、なにが実行されているか見えなくなるのであまり好きじゃない。Ansibleは実行順序をかけるので、自分で明示する方がいい。

role dependency は ansible-galaxy のために作られたもの

- Q: 開発環境、ステージング環境ごとに中身が違うみたいなことってどうするの?
- A: 変数で切り替えるのがよい。条件付き実行を使って、productionならそれ用の変数を読み込むという指定をする。modeでproduction/stagingを切り替えている
- Q: クラウド用のコマンドを抽象化したようなものとかないかな
- A: 今のところはない。それぞれのサービスが提供する機能が違うため。共通化すると設定できることが少なくなりそう。

- ディストリビューションのパッケージのインストールはAnsibleはyum, aptと分かれている。packageに統一してという話も出ているが、統一されていない。インストールするパッケージ名がapache2/httpd2のように異なるため分けている。

6-4 よく使うモジュール
----------------------
一番知ってほしいのはscriptモジュール。
scriptモジュールがあれば今あるscriptを使える。
script実行時にcreates引数をつけることによって、一回だけ実行されるスクリプトになる。これで簡易的に冪等性があるといえることになる。

shellモジュールは普通にshellとしてコマンドが実行できる。

ver 1.9で260、ver 2.0で400くらいのモジュールがある。
何かしたいなーと思ったら、docs.ansible.comを検索してモジュールを探す。

Ansibleはbetter shell scriptだと思っている。
分散して、書き方が統一できて、複数サーバー実行して、冪等性もあるというイメージ。

- Q: すべての構成をAnsibleでやるとかいう考えは?
- A: とくにない。

Ansible使ってshellモジュールで実行したりとかもやる。

- Q: Dockerとk8sっていうのとAnsibleとかを使い分けたらいいの?Capstranoとかともまた違うの?Ansibleの使いドコロってどこなんだろう?
- A: 自動化ツールとして2系統がある。configration management tool(構成管理ツール)chef, puppet等、orchestration tool(リモート実行ツール)capistrano, fabricとか。Ansibleは両方できるのが売りになっている。
  Simple, Agentless, Powerful
  AnsibleよりDockerがいいと思っていて、Ansibleは過渡期に使われるものと考えている。Dockerの方が筋がいいと思っている。
  3年後とかになるとDockerで速いみたいなのがあるかも知れない。Ansibleは現実。

- Q: Ansible.comってどうやって食べてるの?
- A: Ansible社の人がメインで公開で開発している。Ansible社はAnsible Towerというものを売っている。Web画面から実行したり、Webhookで実行するとかのいろんな機能が付いている。他はトレーニングとかコンサルティングとかをやっている。使ったことはない。
  Ansible Tower
- Q: オーケストレーションができるとあったが、複数サーバー間の連携とかできるのか?
- A: シリアル実行でやればいいかな
- Q: Playbookのファイルをリポジトリで管理するのが望ましい。リポジトリはどこがいい?
- A: Gitとかで github でもいいし社内のgitサーバーでもいいと思っている
- Q: sshの秘密鍵の管理とかどうしてる?
- A: ファイルについては分けておいたほうがよい。パスワード、Tokenとかの情報をPlaybookに書きたい場合がある。Ansible vaultという機能がある。暗号化してPlaybookに書き込み、実行時にパスワードを入力すると復号化して実行するみたいなこともできる
- A: HashiCorpのXXXってやつも秘密情報持てるので、それと連携するのはよいかも

Appendix2 ますます活躍の場が広がるPython
========================================
ここはざっと説明して終了

ビアバッシュ(懇親会)
====================
- ansible の cow say
- コードゴルフ→

まとめ
======
